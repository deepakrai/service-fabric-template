{
    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "omsWorkspaceName": {
            "type": "string",
            "metadata": {
                "description": "Name for the Log Analytic Workspace"
            }
        },
        "omsWorkspaceRegion": {
            "type": "string",
            "defaultValue": "East US",
            "allowedValues": [
                "East US",
                "West Europe",
                "Southeast Asia",
                "Australia Southeast"
            ],
            "metadata": {
                "description": "Specify the region for your Workspace"
            }
        },
        "omsServiceTier": {
            "type": "string",
            "allowedValues": [
                "Free",
                "Standalone",
                "PerNode"
            ],
            "defaultValue": "PerNode",
            "metadata": {
                "description": "Service Tier: Free, Standalone, or PerNode"
            }
        },
        "omsPerfCounterInterval": {
            "type": "string",
            "defaultValue": "60",
            "metadata": {
                "description": "Performance counter reporting interval (in seconds)"
            }
        },
        "applicationDiagnosticsStorageAccountName": {
            "type": "string",
            "metadata": {
                "description": "Storage Account name for OMS to monitor"
            }
        }
    },
    "variables": {
        "logAnalyticsApiVersion": "2015-11-01-preview",
        "solutions": [
            {
                "name": "[concat('Security', '(', parameters('omsWorkspaceName'), ')')]",
                "marketplaceName": "Security"
            },
            {
                "name": "[concat('AgentHealthAssessment', '(', parameters('omsWorkspaceName'), ')')]",
                "marketplaceName": "AgentHealthAssessment"
            },
            {
                "name": "[concat('ServiceFabric', '(', parameters('omsWorkspaceName'), ')')]",
                "marketplaceName": "ServiceFabric"
            }
        ],
        "queries": [
            {
                "name": "D Drive Free Space",
                "displayName": "D Drive Free Space (%)",
                "category": "Service Fabric",
                "query": "Perf | where ( ObjectName == 'LogicalDisk' ) | where ( InstanceName == 'D:' ) | where ( CounterName == '% Free Space' ) | where TimeGenerated < ago(10minutes) | summarize FreeSpace_DDisk_Percent = avg(CounterValue) by Computer",
                "schedule": {
                    "interval": 15,
                    "timeSpan": 60
                }
            }
        ],
        "perfCounters": [
            {
                "name": "DiskAvgWritePerfCounter",
                "objectName": "LogicalDisk",
                "counterName": "Avg Disk sec/Write"
            },
            {
                "name": "DiskAvgReadPerfCounter",
                "objectName": "LogicalDisk",
                "counterName": "Avg Disk sec/Read"
            },
            {
                "name": "DiskCurrentQueueLengthPerfCounter",
                "objectName": "LogicalDisk",
                "counterName": "Current Disk Queue Length"
            },
            {
                "name": "DiskReadsSecPerfCounter",
                "objectName": "LogicalDisk",
                "counterName": "Disk Reads/sec"
            },
            {
                "name": "DiskTransSecPerfCounter",
                "objectName": "LogicalDisk",
                "counterName": "Disk Transfers/sec"
            },
            {
                "name": "DiskWriteSecPerfCounter",
                "objectName": "LogicalDisk",
                "counterName": "Disk Writes/sec"
            },
            {
                "name": "DiskFreeMegabytesPerfCounter",
                "objectName": "LogicalDisk",
                "counterName": "Free Megabytes"
            },
            {
                "name": "DiskPctFreeSpacePerfCounter",
                "objectName": "LogicalDisk",
                "counterName": "% Free Space"
            },
            {
                "name": "MemoryAvailableMBytesPerfCounter",
                "objectName": "Memory",
                "counterName": "Available MBytes"
            },
            {
                "name": "MemoryPctCommittedPerfCounter",
                "objectName": "LogicalDisk",
                "counterName": "% Committed Bytes In Use"
            },
            {
                "name": "NetworkBytesReceivedSecPerfCounter",
                "objectName": "Network Adapter",
                "counterName": "Bytes Received/sec"
            },
            {
                "name": "NetworkBytesSentSecPerfCounter",
                "objectName": "Network Adapter",
                "counterName": "Bytes Sent/sec"
            },
            {
                "name": "NetworkBytesTotalSecPerfCounter",
                "objectName": "Network Interface",
                "counterName": "Bytes Total/sec"
            },
            {
                "name": "ProcessorPctTotalTimePerfCounter",
                "objectName": "Processor",
                "counterName": "% Processor Time"
            },
            {
                "name": "SystemProcessorQueueLengthPerfCounter",
                "objectName": "System",
                "counterName": "Processor Queue Length"
            }
        ]
    },
    "resources": [
        {
            "apiVersion": "[variables('logAnalyticsApiVersion')]",
            "type": "Microsoft.OperationalInsights/workspaces",
            "name": "[parameters('omsWorkspaceName')]",
            "location": "[parameters('omsWorkspaceRegion')]",
            "comments": "Log Analytics Workspace",
            "properties": {
                "sku": {
                    "name": "[parameters('omsServiceTier')]"
                }
            },
            "resources": [
                {
                    "apiVersion": "[variables('logAnalyticsApiVersion')]",
                    "name": "AzureActivityLog",
                    "type": "datasources",
                    "dependsOn": [
                        "[concat('Microsoft.OperationalInsights/workspaces/', parameters('omsWorkspaceName'))]"
                    ],
                    "kind": "AzureActivityLog",
                    "properties": {
                        "linkedResourceId": "[concat(subscription().id, '/providers/Microsoft.Insights/eventTypes/management')]"
                    }
                },
                {
                    "apiVersion": "[variables('logAnalyticsApiVersion')]",
                    "type": "datasources",
                    "name": "System",
                    "dependsOn": [
                        "[concat('Microsoft.OperationalInsights/workspaces/', parameters('omsWorkspaceName'))]"
                    ],
                    "kind": "WindowsEvent",
                    "properties": {
                        "eventLogName": "System",
                        "eventTypes": [
                            {
                                "eventType": "Error"
                            },
                            {
                                "eventType": "Warning"
                            }
                        ]
                    }
                },
                {
                    "apiVersion": "[variables('logAnalyticsApiVersion')]",
                    "type": "datasources",
                    "name": "Application",
                    "dependsOn": [
                        "[concat('Microsoft.OperationalInsights/workspaces/', parameters('omsWorkspaceName'))]"
                    ],
                    "kind": "WindowsEvent",
                    "properties": {
                        "eventLogName": "Application",
                        "eventTypes": [
                            {
                                "eventType": "Error"
                            },
                            {
                                "eventType": "Warning"
                            }
                        ]
                    }
                },
                {
                    "apiVersion": "[variables('logAnalyticsApiVersion')]",
                    "name": "ApplicationDiagnosticsStorage",
                    "type": "storageinsightconfigs",
                    "dependsOn": [
                        "[concat('Microsoft.OperationalInsights/workspaces/', parameters('omsWorkspacename'))]"
                    ],
                    "properties": {
                        "containers": [],
                        "tables": [
                            "WADPerformanceCountersTable",
                            "WADServiceFabric*EventTable",
                            "WADWindowsEventLogsTable",
                            "WADETWEventTable"
                        ],
                        "storageAccount": {
                            "id": "[resourceId('Microsoft.Storage/storageaccounts/', parameters('applicationDiagnosticsStorageAccountName'))]",
                            "key": "[listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('applicationDiagnosticsStorageAccountName')),'2015-06-15').key1]"
                        }
                    }
                }
            ]
        },
        {
            "apiVersion": "2017-03-03-preview",
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
            "name": "[concat(parameters('omsWorkspaceName'), '/', variables('queries')[copyIndex()].Name)]",
            "dependsOn": [
                "[concat('Microsoft.OperationalInsights/workspaces/', parameters('omsWorkspaceName'))]"
            ],
            "copy": {
                "name": "queryCopy",
                "count": "[length(variables('queries'))]"
            },
            "properties": {
                "etag": "*",
                "query": "[variables('queries')[copyIndex()].query]",
                "displayName": "[variables('queries')[copyIndex()].displayName]",
                "category": "[variables('queries')[copyIndex()].category]"
            }
        },
        {
            "apiVersion": "[variables('logAnalyticsApiVersion')]",
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches/schedules",
            "name": "[concat(parameters('omsWorkspaceName'), '/', variables('queries')[copyIndex()].Name, '/schedule')]",
            "condition": "[not(empty(string(variables('queries')[copyIndex()].schedule.interval)))]",
            "dependsOn": [
                "[concat('Microsoft.OperationalInsights/workspaces/', parameters('omsWorkspaceName'))]",
                "[concat('Microsoft.OperationalInsights/workspaces/', parameters('omsWorkspaceName'), '/savedSearches/', variables('queries')[copyIndex()].Name)]"
            ],
            "copy": {
                "name": "queryCopy",
                "count": "[length(variables('queries'))]"
            },
            "properties": {
                "etag": "*",
                "interval": "[variables('queries')[copyIndex()].schedule.interval]",
                "queryTimeSpan": "[variables('queries')[copyIndex()].schedule.timeSpan]",
                "enabled": true
            }
        },
        {
            "apiVersion": "[variables('logAnalyticsApiVersion')]",
            "name": "[concat(parameters('omsWorkspaceName'), '/', variables('perfCounters')[copyIndex()].Name)]",
            "type": "Microsoft.OperationalInsights/workspaces/dataSources",
            "dependsOn": [
                "[concat('Microsoft.OperationalInsights/workspaces/', parameters('omsWorkspaceName'))]"
            ],
            "kind": "WindowsPerformanceCounter",
            "copy": {
                "name": "perfCountersCopy",
                "count": "[length(variables('perfCounters'))]"
            },
            "properties": {
                "objectName": "[variables('perfCounters')[copyIndex()].ObjectName]",
                "instanceName": "*",
                "intervalSeconds": "[parameters('omsPerfCounterInterval')]",
                "counterName": "[variables('perfCounters')[copyIndex()].CounterName]"
            }
        },
        {
            "apiVersion": "[variables('logAnalyticsApiVersion')]",
            "type": "Microsoft.OperationsManagement/solutions",
            "name": "[concat(variables('solutions')[copyIndex()].Name)]",
            "location": "[parameters('omsWorkspaceRegion')]",
            "dependsOn": [
                "[concat('Microsoft.OperationalInsights/workspaces/', parameters('omsWorkspaceName'))]"
            ],
            "copy": {
                "name": "solutionCopy",
                "count": "[length(variables('solutions'))]"
            },
            "properties": {
                "workspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('omsWorkspaceName'))]"
            },
            "plan": {
                "name": "[variables('solutions')[copyIndex()].name]",
                "product": "[concat('OMSGallery/', variables('solutions')[copyIndex()].marketplaceName)]",
                "promotionCode": "",
                "publisher": "Microsoft"
            }
        }
    ],
    "outputs": {
        "omsWorkspaceId": {
            "type": "string",
            "value": "[reference(resourceId('Microsoft.OperationalInsights/workspaces/', parameters('omsWorkspacename')), '2015-11-01-preview').customerId]"
        },
        "omsWorkspaceKey": {
            "type": "string",
            "value": "[listKeys(resourceId('Microsoft.OperationalInsights/workspaces/', parameters('omsWorkspacename')), '2015-11-01-preview').primarySharedKey]"
        }
    }
}
{
    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "omsWorkspaceName": {
            "type": "string",
            "metadata": {
                "description": "Name for the Log Analytic Workspace"
            }
        },
        "omsWorkspaceRegion": {
            "type": "string",
            "defaultValue": "East US",
            "allowedValues": [
                "East US",
                "West Europe",
                "Southeast Asia",
                "Australia Southeast"
            ],
            "metadata": {
                "description": "Specify the region for your Workspace"
            }
        },
        "omsServiceTier": {
            "type": "string",
            "allowedValues": [
                "Free",
                "Standalone",
                "PerNode"
            ],
            "defaultValue": "PerNode",
            "metadata": {
                "description": "Service Tier: Free, Standalone, or PerNode"
            }
        },
        "omsPerfCounterInterval": {
            "type": "string",
            "defaultValue": "60",
            "metadata": {
                "description": "Performance counter reporting interval (in seconds)"
            }
        },
        "applicationDiagnosticsStorageAccountName": {
            "type": "string",
            "metadata": {
                "description": "Storage Account name for OMS to monitor"
            }
        }
    },
    "variables": {
            "solutions": [
                {
                    "name": "[concat('Security', '(', parameters('omsWorkspaceName'), ')')]",
                    "marketplaceName": "Security"
                },
                {
                    "name": "[concat('AgentHealthAssessment', '(', parameters('omsWorkspaceName'), ')')]",
                    "marketplaceName": "AgentHealthAssessment"
                },
                {
                    "name": "[concat('ServiceFabric', '(', parameters('omsWorkspaceName'), ')')]",
                    "marketplaceName": "ServiceFabric"
                }
            ],
            "queries": [
                {
                    "displayName": "Error records by hour",
                    "query": "Type=MyRecord_CL | measure avg(Rating_d) by Instance_s interval 60minutes",
                    "category": "Samples",
                    "name": "Samples-Count of data"
                }
            ],
            "perfCounters": [
                {
                    "name": "DiskAvgWritePerfCounter",
                    "objectName": "LogicalDisk",
                    "counterName": "Avg Disk sec/Write"
                },
                {
                    "name": "DiskAvgReadPerfCounter",
                    "objectName": "LogicalDisk",
                    "counterName": "Avg Disk sec/Read"
                },
                {
                    "name": "DiskCurrentQueueLengthPerfCounter",
                    "objectName": "LogicalDisk",
                    "counterName": "Current Disk Queue Length"
                },
                {
                    "name": "DiskReadsSecPerfCounter",
                    "objectName": "LogicalDisk",
                    "counterName": "Disk Reads/sec"
                },
                {
                    "name": "DiskTransSecPerfCounter",
                    "objectName": "LogicalDisk",
                    "counterName": "Disk Transfers/sec"
                },
                {
                    "name": "DiskWriteSecPerfCounter",
                    "objectName": "LogicalDisk",
                    "counterName": "Disk Writes/sec"
                },
                {
                    "name": "DiskFreeMegabytesPerfCounter",
                    "objectName": "LogicalDisk",
                    "counterName": "Free Megabytes"
                },
                {
                    "name": "DiskPctFreeSpacePerfCounter",
                    "objectName": "LogicalDisk",
                    "counterName": "% Free Space"
                },
                {
                    "name": "MemoryAvailableMBytesPerfCounter",
                    "objectName": "Memory",
                    "counterName": "Available MBytes"
                },
                {
                    "name": "MemoryPctCommittedPerfCounter",
                    "objectName": "LogicalDisk",
                    "counterName": "% Committed Bytes In Use"
                },
                {
                    "name": "NetworkBytesReceivedSecPerfCounter",
                    "objectName": "Network Adapter",
                    "counterName": "Bytes Received/sec"
                },
                {
                    "name": "NetworkBytesSentSecPerfCounter",
                    "objectName": "Network Adapter",
                    "counterName": "Bytes Sent/sec"
                },
                {
                    "name": "NetworkBytesTotalSecPerfCounter",
                    "objectName": "Network Interface",
                    "counterName": "Bytes Total/sec"
                },
                {
                    "name": "ProcessorPctTotalTimePerfCounter",
                    "objectName": "Processor",
                    "counterName": "% Processor Time"
                },
                {
                    "name": "SystemProcessorQueueLengthPerfCounter",
                    "objectName": "System",
                    "counterName": "Processor Queue Length"
                }
            ]
    },
    "resources": [
        {
            "apiVersion": "2017-03-15-preview",
            "type": "Microsoft.OperationalInsights/workspaces",
            "name": "[parameters('omsWorkspaceName')]",
            "location": "[parameters('omsWorkspaceRegion')]",
            "comments": "Log Analytics Workspace",
            "properties": {
                "sku": {
                    "name": "[parameters('omsServiceTier')]"
                }
            }
        },
        {
            "apiVersion": "2017-03-15-preview",
            "name": "[concat(parameters('omsWorkspaceName'), '/', variables('queries')[copyIndex()].Name)]",
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
            "apiVersion": "2015-11-01-preview",
            "dependsOn": [
                "[concat('Microsoft.OperationalInsights/workspaces/', parameters('omsWorkspaceName'))]"
            ],
            "copy": {
                "name": "queryCopy",
                "count": "[length(variables('queries'))]"
            },
            "properties": {
                "etag": "*",
                "query": "[variables('queries')[copyIndex()].query]",
                "displayName": "[variables('queries')[copyIndex()].displayName]",
                "category": "[variables('queries')[copyIndex()].category]"
            }
        },
        {
            "apiVersion": "2015-11-01-preview",
            "type": "Microsoft.OperationsManagement/solutions",
            "name": "[concat(variables('solutions')[copyIndex()].Name)]",
            "location": "[parameters('omsWorkspaceRegion')]",
            "dependsOn": [
                "[concat('Microsoft.OperationalInsights/workspaces/', parameters('omsWorkspaceName'))]"
            ],
            "copy": {
                "name": "solutionCopy",
                "count": "[length(variables('solutions'))]"
            },
            "properties": {
                "workspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('omsWorkspaceName'))]"
            },
            "plan": {
                "name": "[variables('solutions')[copyIndex()].name]",
                "product": "[concat('OMSGallery/', variables('solutions')[copyIndex()].marketplaceName)]",
                "promotionCode": "",
                "publisher": "Microsoft"
            }
        }
    ],
    "outputs": {
        "omsWorkspaceId": {
            "type": "string",
            "value": "[reference(resourceId('Microsoft.OperationalInsights/workspaces/', parameters('omsWorkspacename')), '2015-11-01-preview').customerId]"
        },
        "omsWorkspaceKey": {
            "type": "string",
            "value": "[listKeys(resourceId('Microsoft.OperationalInsights/workspaces/', parameters('omsWorkspacename')), '2015-11-01-preview').primarySharedKey]"
        }
    }
}